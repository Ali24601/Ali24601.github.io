---
layout: post
title: 函数名修饰规则
---

一、函数名称修饰规则

函数的名字修饰（Decorated Name）就是编译器在编译期间创建的一个字符串，用来指明函数的定义或原型。LINK程序或其他工具有时需要指定函数的名字修饰来定位函数的正确位置。由于c语言不支持函数重载，而c++语言支持函数重载，所以c和c++的函数名称修饰规则是不相同的。

以下面这个Add函数为例，来探讨一下c和c++语言的函数名称修饰规则。

int Add(int x, int y)
{
	return x + y;
}

1.c语言的函数名称修饰规则：
c语言将上面的函数名称处理为_Add，即其修饰规则为_函数名（函数名前加_）。
对于不同调用约定，名为functionname()且参数字节数为number 的函数名修饰规则如下：
'''
---|----------
__cdecl   _functionname
__stdcall _functionname@number 
__fastcall @functionname@number 
---|----------
'''

2.c++语言的函数名称修饰规则：
c++语言将上面的函数名称处理为'?Add@@YAHHH@Z (int __cdecl Add(int,int))' (这个叫做函数名压扎)  

（1）其中‘？’标识函数名的开始，其后跟函数名；

（2）“@@YA”标识参数表的开始，表示调用约定为__cdecl。常见调用约定和对应标识符如下：
'''
---|----------
YA |  __cdecl
YG |  __stdcall
YI |  __fastcall
---|----------
'''

其后跟的第一个字符代表函数的返回值类型，接下来的字符依次代表函数参数列表中各个参数的类型；

	类型的代号：

	 x--void，   
	 d--char，   
	 e--unsigned   char，   
	 f--short，   
	 h--int，   
	 i--unsigned   int，   
	 j--long，   
	 k--unsigned   long，   
	 m--float，   
	 n--double，   
	_n--bool，   
	...  ...

所以@@yg后面的HHH分别代表三个int类型，其中第一个为函数返回值，上下两个为参数类型。

（3）@z标识整个名字结束。如果该函数无参数，则以“Z”标识结束。

c++中类成员函数名称修饰也有自己的规则，这里不阐开。

3.使用dumpbin查看修饰的函数名
dumpbin /SYMBOLS combo.obj


通过上面的分析，我们发现不同的编译器对函数名称修饰的规则是不同的，但我们依然可以找到规律，c语言对函数名称修饰的处理只关注到了函数名；而c++语言除了函数名，还关注了函数的参数，通过对函数名称的修饰不同，编译器调用函数时所找的符号就不同，因而c++语言支持函数重载。也可得出构成函数重载的条件为函数名相同，参数不同，返回值类型可同可不同。


二、extern "C" 的作用

在c++文件中可以直接利用extern使用c文件中的代码吗？
不可以，因为c和c++中同名函数的修饰名不同，调用者找不到函数定义。可以采用extern "C" 告诉编译器这部分代码使用c语言的规则进行编译和链接。这样就能在C文件中找到这个函数定义。
